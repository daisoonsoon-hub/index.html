<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>離島鎮守府 脱出行（PWA 1file v2）</title>
<style>
  :root{
    --bg:#0e0f12; --panel:#171a20; --panel2:#12141a; --line:#2a2f3a;
    --txt:#e9edf4; --muted:#a9b2c3; --accent:#69c0ff; --danger:#ff6b6b; --ok:#7CFF7C;
    --btn:#232836; --btn2:#2b3142;
    --r:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  header{padding:10px 12px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,var(--panel),var(--panel2))}
  header .title{font-weight:800;font-size:16px}
  header .sub{color:var(--muted);font-size:12px;margin-top:2px}
  main{padding:12px;display:flex;flex-direction:column;gap:10px;min-height:calc(100vh - 56px)}
  .row{display:flex;gap:10px;align-items:stretch}
  .col{flex:1;display:flex;flex-direction:column;gap:10px;min-width:0}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--r);overflow:hidden}
  .card .hd{padding:10px 10px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center;justify-content:space-between}
  .card .hd .h{font-weight:800}
  .card .bd{padding:10px}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);color:var(--muted);font-size:12px}
  .pill b{color:var(--txt)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  button{
    width:100%;border:1px solid rgba(255,255,255,.10);background:var(--btn);color:var(--txt);
    padding:10px 8px;border-radius:12px;font-weight:750;letter-spacing:.02em;
    transition:.08s transform,.08s background;
  }
  button:active{transform:scale(.99);background:var(--btn2)}
  button[disabled]{opacity:.35}
  .log{height:44vh;overflow:auto;line-height:1.6}
  .log .sep{margin:10px 0;border-top:1px dashed rgba(255,255,255,.15)}
  .muted{color:var(--muted)}
  .danger{color:var(--danger)}
  .ok{color:var(--ok)}
  .small{font-size:12px}
  .right{margin-left:auto}
  .tag{display:inline-block;font-size:11px;color:var(--muted);border:1px solid rgba(255,255,255,.12);padding:2px 6px;border-radius:999px;margin-left:6px}
  .hr{height:1px;background:var(--line);margin:10px 0}

  /* Image */
  .sceneImg{height:150px;border-radius:14px;border:1px solid rgba(255,255,255,.10);overflow:hidden;background:#0b0c10}
  .sceneImg img{width:100%;height:100%;object-fit:cover;display:block;opacity:.95}

  /* Modal */
  .modalWrap{position:fixed;inset:0;background:rgba(0,0,0,.62);display:none;align-items:flex-end;justify-content:center;padding:12px}
  .modalWrap.show{display:flex}
  .modal{
    width:min(760px,100%);max-height:82vh;overflow:auto;
    background:var(--panel);border:1px solid var(--line);border-radius:18px;
    box-shadow:0 14px 50px rgba(0,0,0,.45);
  }
  .modal .top{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
  .modal .top .t{font-weight:900}
  .modal .top .x{margin-left:auto;width:auto;padding:8px 10px;border-radius:12px}
  .modal .body{padding:12px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:rgba(20,22,28,.95);border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:14px;display:none}
  .toast.show{display:block}
</style>
</head>
<body>
<header>
  <div class="title">離島鎮守府 脱出行</div>
  <div class="sub">コマンド → 対象選択式 / 有限資源 / 調査で対象増殖 / 「脱走疑い」以後は捕縛圧</div>
</header>

<main>
  <div class="card">
    <div class="hd">
      <div class="h" id="placeName">—</div>
      <div class="pill"><span>ターン</span> <b id="turn">0</b></div>
      <div class="pill"><span>警戒</span> <b id="alert">10</b></div>
      <div class="pill"><span>燃料</span> <b id="fuel">25</b></div>
      <button class="right" style="width:auto" id="btnMenu">MENU</button>
    </div>

    <div class="bd">
      <div class="sceneImg" title="背景（後で差し替え可）"><img id="sceneImg" alt="scene"></div>
      <div class="hr"></div>

      <div class="grid2">
        <div>
          <div class="small muted">目的</div>
          <div id="objective" style="margin-top:4px">—</div>
          <div class="hr"></div>
          <div class="small muted">現在地の状況</div>
          <div id="situation" style="margin-top:4px">—</div>
        </div>
        <div>
          <div class="small muted">出現中</div>
          <div id="present" style="margin-top:4px">—</div>
          <div class="hr"></div>
          <div class="small muted">同行</div>
          <div id="party" style="margin-top:4px">—</div>
          <div class="hr"></div>
          <div class="small muted">所持品</div>
          <div id="inv" style="margin-top:4px">—</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col card">
      <div class="hd"><div class="h">ログ</div><div class="small muted">（新しいほど下）</div></div>
      <div class="bd log" id="log"></div>
    </div>

    <div class="col" style="max-width:440px">
      <div class="card">
        <div class="hd"><div class="h">コマンド</div><div class="small muted">押す→対象選択</div></div>
        <div class="bd"><div class="grid3" id="cmdGrid"></div></div>
      </div>

      <div class="card">
        <div class="hd"><div class="h">艦娘</div><div class="small muted">信頼/親密（敵にも味方にも）</div></div>
        <div class="bd" id="chars"></div>
      </div>
    </div>
  </div>
</main>

<!-- Target Modal -->
<div class="modalWrap" id="modalWrap">
  <div class="modal">
    <div class="top">
      <div class="t" id="modalTitle">—</div>
      <button class="x" id="modalClose">閉じる</button>
    </div>
    <div class="body">
      <div class="small muted" id="modalHint">—</div>
      <div class="hr"></div>
      <div class="grid2" id="targetGrid"></div>
    </div>
  </div>
</div>

<!-- Menu Modal -->
<div class="modalWrap" id="menuWrap">
  <div class="modal">
    <div class="top">
      <div class="t">MENU</div>
      <button class="x" id="menuClose">閉じる</button>
    </div>
    <div class="body">
      <div class="grid2">
        <button id="btnSave">セーブ（端末）</button>
        <button id="btnLoad">ロード（端末）</button>
        <button id="btnRestart">最初から</button>
        <button id="btnReplay">同条件で最初から（seed維持）</button>
      </div>
      <div class="hr"></div>
      <div class="small muted">
        ・端末セーブは localStorage 使用。<br>
        ・同条件リプレイは調整に便利。<br>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================
   Data
========================= */
const CMD = [
  {id:"move", label:"移動", hint:"移動先を選ぶ"},
  {id:"examine", label:"調べる", hint:"場所/物/人物を調べる（調べるほど対象が増える）"},
  {id:"touch", label:"触る", hint:"装置/扉/人物に触れる（場にいる艦娘も対象）"},
  {id:"hide", label:"隠れる", hint:"警戒を下げる。脱走疑いを薄める"},
  {id:"pickup", label:"拾う", hint:"発見済みの物だけ拾える（有限）"},
  {id:"drop", label:"捨てる", hint:"所持枠整理"},
  {id:"talk", label:"話す", hint:"会話で信頼/親密。状況によっては詰問される"},
  {id:"use", label:"使う", hint:"アイテム/装置に使う"},
  {id:"order", label:"命令", hint:"強い指示。状況を動かすが反発も"},
  {id:"run", label:"逃げる", hint:"離脱。脱走疑いが濃くなる"},
  {id:"apologize", label:"謝る", hint:"空気を戻す。しつこいと逆効果"},
  {id:"fight", label:"闘う", hint:"交戦。音は残る。捕縛圧が上がる"},
];

const CHAR = {
  shigure:{name:"時雨", style:"静かな観察", orderMin:25},
  asashio:{name:"朝潮", style:"規律と忠誠", orderMin:15},
  kasumi:{name:"霞", style:"辛口の現実", orderMin:45},
  takao:{name:"高雄", style:"筋を通す", orderMin:25},
  kongo:{name:"金剛", style:"勢いと明るさ", orderMin:30},
  hatsuzuki:{name:"初月", style:"合理主義", orderMin:25},
  urakaze:{name:"浦風", style:"気遣いと調整", orderMin:20},
  ikazuchi:{name:"雷", style:"元気と距離近め", orderMin:30},
  hibiki:{name:"響", style:"寡黙で鋭い", orderMin:20},
};

// 画像（内蔵SVG。あとで好きな画像URL/データURIに差し替え可能）
function svgScene(title, a="#0b1020", b="#131a2d", accent="#69c0ff"){
  const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="600">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="${a}"/>
      <stop offset="1" stop-color="${b}"/>
    </linearGradient>
  </defs>
  <rect width="1200" height="600" fill="url(#g)"/>
  <circle cx="980" cy="120" r="70" fill="${accent}" opacity="0.18"/>
  <circle cx="1060" cy="180" r="110" fill="${accent}" opacity="0.10"/>
  <path d="M0,430 C250,350 420,520 650,455 C870,390 960,520 1200,430 L1200,600 L0,600 Z"
        fill="#0a0c12" opacity="0.65"/>
  <path d="M0,470 C260,390 430,560 650,500 C880,435 960,570 1200,470"
        fill="#000" opacity="0.25"/>
  <text x="36" y="70" fill="#e9edf4" font-size="44" font-family="system-ui, sans-serif" opacity="0.92">${title}</text>
  <text x="38" y="110" fill="#a9b2c3" font-size="22" font-family="system-ui, sans-serif" opacity="0.85">離島鎮守府 — 夜の海</text>
</svg>`;
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

const LOC = {
  hq:{name:"司令室", exits:["radio","workshop","storage","quarters","watch"], danger:6, img:()=>svgScene("司令室", "#0a0f1b","#151b2b"),
      situation:["海図が黒い。机の角が冷える。","紙の匂いが残っている。"], objects:["机","海図","書類棚"]},
  radio:{name:"無線室", exits:["hq","watch"], danger:10, img:()=>svgScene("無線室", "#080d18","#121a2e"),
      situation:["ノイズが薄く、逆に不気味だ。","ランプの瞬きが規則正しい。"], objects:["受信機","アンテナ基部","暗号表の引き出し"]},
  workshop:{name:"工廠", exits:["hq","dock","generator"], danger:9, img:()=>svgScene("工廠", "#0a0d12","#1b1f2a"),
      situation:["油と金属。工具は整然としている。","床に擦れ跡が多い。"], objects:["作業台","工具箱","予備部材棚"]},
  storage:{name:"資材庫", exits:["hq","dock","warehouse"], danger:11, img:()=>svgScene("資材庫", "#0b0b12","#1a1724"),
      situation:["棚の影が深い。箱の隙間が黒い。","湿った木箱が並ぶ。"], objects:["戸棚","棚","木箱"]},
  quarters:{name:"居住区", exits:["hq","mess","bath"], danger:7, img:()=>svgScene("居住区", "#0d0f14","#1a2230"),
      situation:["生活の匂い。気配が出やすい。","寝台が整いすぎている。"], objects:["寝台","私物箱","カーテン"]},
  mess:{name:"食堂", exits:["quarters","hq"], danger:6, img:()=>svgScene("食堂", "#0c1016","#17212a"),
      situation:["食器の音が残っている気がする。","配膳口の奥が暗い。"], objects:["テーブル","配膳口","貯水槽"]},
  watch:{name:"見張り台", exits:["hq","radio","yard"], danger:12, img:()=>svgScene("見張り台", "#060c16","#14243a"),
      situation:["風が冷たい。視界が利くぶん危ない。","海がこちらを見ている。"], objects:["双眼鏡","警鐘","照明スイッチ"]},
  yard:{name:"中庭", exits:["watch","dock","armory","tunnel"], danger:13, img:()=>svgScene("中庭", "#070b12","#1b1a26"),
      situation:["砂利が足音を売る。","外灯が揺れて影が伸びる。"], objects:["外灯","通路","排水溝"]},
  armory:{name:"兵装庫", exits:["yard","dock"], danger:14, img:()=>svgScene("兵装庫", "#0b0b10","#20161a"),
      situation:["金属臭が強い。扉が重い。","物が多く隠れやすいが危険。"], objects:["兵装棚","木箱","固定具"]},
  dock:{name:"埠頭", exits:["yard","workshop","storage","armory","tunnel"], danger:16, img:()=>svgScene("埠頭", "#050a12","#0f2032"),
      situation:["波が硬い音を立てる。出るならここだ。","封鎖ゲートが道を塞ぐ。"], objects:["輸送船","封鎖ゲート","繋留杭"]},
  bath:{name:"浴場", exits:["quarters"], danger:8, img:()=>svgScene("浴場", "#0d0c14","#1b1b2a"),
      situation:["湿気が残る。足音が吸われる。","湯気の名残が視界を鈍らせる。"], objects:["脱衣棚","洗い場","鏡"]},
  tunnel:{name:"連絡坑道", exits:["dock","yard","generator"], danger:15, img:()=>svgScene("連絡坑道", "#080a10","#14161d"),
      situation:["狭い。距離が近い。","配管の温度が高い。"], objects:["配管","点検口","ケーブル"]},
  generator:{name:"発電室", exits:["workshop","tunnel"], danger:17, img:()=>svgScene("発電室", "#070a10","#10151f"),
      situation:["低い振動。音は隠れ蓑にもなる。","機械の唸りが耳に残る。"], objects:["発電機","制御盤","換気扇"]},
  warehouse:{name:"外倉庫", exits:["yard","storage"], danger:14, img:()=>svgScene("外倉庫", "#0a0a12","#1b1a2a"),
      situation:["鉄扉が湿って滑る。","外気が冷たく、気配が鋭い。"], objects:["鉄扉","パレット","防水シート"]},
};

// アイテム（このゲームでは「調査→発見→拾う」で初めて入手）
const ITEMS = {
  scrap:{name:"部品片", desc:"工廠の整備に使える（有限）"},
  gate_key:{name:"ゲート鍵", desc:"埠頭の封鎖ゲート解除"},
  codebook:{name:"暗号表", desc:"無線照合を安定させる"},
  fuel_can:{name:"燃料缶", desc:"燃料+8（有限）"},
  cloth_tag:{name:"タグ付き布片", desc:"脱衣棚から出る。持っていると追跡が鈍ることがある"},
};

const END = {
  normal:"【ノーマルエンド】本土に帰投した。",
  bad:"【バッドエンド】捕縛され、脱走は止められた。",
  harem:"【ハーレムエンド】多くの艦娘と強い関係を築いたまま結末を迎えた。",
  king:"【王エンド】全員との関係を完成させ、結末を統べた。",
  dream:"【胡蝶の夢提督エンド】誰にも気取られず、静かに渡り切った。",
};

/* =========================
   RNG (seed)
========================= */
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;}}
let seed = (Date.now()>>>0) ^ 0xA5A5A5A5;
let rnd = mulberry32(seed);
const rint = (n)=>Math.floor(rnd()*n);
const chance = (p)=>rnd()*100 < p;
const clamp=(v,min=0,max=100)=>Math.max(min,Math.min(max,v));

/* =========================
   Game State
========================= */
function defaultState(){
  const chars = {};
  Object.keys(CHAR).forEach(id=>{
    chars[id] = {id, name:CHAR[id].name, trust:50, intimacy:0, bonded:false, met:false, mood:"中立"};
  });

  // ロケーションごとの「有限資源/発見状態」
  const locState = {};
  Object.keys(LOC).forEach(lid=>{
    locState[lid] = {
      examined:new Set(), // 調べた対象
      touched:new Set(),  // 触った対象
      revealed:new Set(), // 発見済みの「拾える対象」
      depleted:new Set(), // 枯渇した資源
    };
  });

  return {
    seed,
    turn:0,
    alert:10,
    fuel:25,
    inventory:[], invLimit:8,
    location:"hq",
    present:[],           // 出現中（その場にいる）
    party:[],             // 同行（明示的に加入した艦娘のみ）
    flags:new Set(),      // detected_once, route_confirmed, ship_repaired, has_gate_key, gate_opened, escaped_mainland, captured...
    chars,
    locState,
    log:[],
    ended:false,
    ending:null,
  };
}
let S = defaultState();

/* =========================
   UI helpers
========================= */
const logEl = document.getElementById("log");
function pushLog(line, cls=""){
  const div=document.createElement("div");
  if(cls) div.className=cls;
  div.innerHTML=line;
  logEl.appendChild(div);
  logEl.scrollTop = logEl.scrollHeight + 9999;
  S.log.push({line,cls});
  if(S.log.length>320) S.log.shift();
}
function sep(){ pushLog('<div class="sep"></div>'); }

function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1200);
}

function bondedCount(){
  const ids=Object.keys(S.chars);
  const b=ids.filter(id=>S.chars[id].bonded).length;
  return [b, ids.length];
}

function objectiveText(){
  const a=[];
  a.push(S.flags.has("route_confirmed")?`<span class="ok">航路：確定</span>`:`<span class="muted">航路：未確定（無線室）</span>`);
  a.push(S.flags.has("has_gate_key")?`<span class="ok">鍵：確保</span>`:`<span class="muted">鍵：未確保（資材庫/浴場）</span>`);
  a.push(S.flags.has("ship_repaired")?`<span class="ok">整備：完了</span>`:`<span class="muted">整備：未完（工廠）</span>`);
  a.push(S.flags.has("gate_opened")?`<span class="ok">封鎖：解除</span>`:`<span class="muted">封鎖：未解除（埠頭）</span>`);
  a.push(S.fuel>=30?`<span class="ok">燃料：十分</span>`:`<span class="muted">燃料：不足（有限）</span>`);
  return a.join(" / ");
}

function situationText(){
  const L=LOC[S.location];
  const s=L.situation[rint(L.situation.length)];
  const pressure = L.danger + Math.floor(S.alert/10) + (S.flags.has("detected_once")?2:0);
  const p = pressure>=22?`<span class="danger">捕縛圧：高</span>`: pressure>=16?`<span class="muted">捕縛圧：中</span>`:`<span class="ok">捕縛圧：低</span>`;
  const suspect = S.flags.has("detected_once") ? `<span class="tag">脱走疑い</span>` : `<span class="tag">未疑惑</span>`;
  return `${s} ${suspect} <span class="tag">${p}</span>`;
}

function presentText(){
  if(!S.present.length) return `<span class="muted">—</span>`;
  return S.present.map(id=>`<b>${CHAR[id].name}</b>`).join(" / ");
}

function partyText(){
  if(!S.party.length) return `<span class="muted">—</span>`;
  return S.party.map(id=>`<b>${CHAR[id].name}</b>`).join(" / ");
}

function invText(){
  if(!S.inventory.length) return `<span class="muted">なし</span>`;
  return S.inventory.map(it=>`<span class="pill"><b>${ITEMS[it]?.name ?? it}</b></span>`).join(" ");
}

function stanceOf(id){
  const t=S.chars[id].trust;
  if(t>=75) return "味方寄り";
  if(t<=35) return "敵対寄り";
  return "中立";
}

function renderChars(){
  const box=document.getElementById("chars");
  const ids=Object.keys(S.chars);
  const rows=ids.map(id=>{
    const c=S.chars[id];
    const bond = c.bonded?`<span class="tag ok">深い関係</span>`:"";
    const met = c.met?`<span class="tag">接触</span>`:"";
    const inParty = S.party.includes(id)?`<span class="tag">同行</span>`:"";
    return `
      <div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,.08)">
        <div style="display:flex;gap:8px;align-items:center">
          <b>${c.name}</b> ${met} ${inParty} ${bond}
          <span class="right small muted">信頼 ${c.trust} / 親密 ${c.intimacy}</span>
        </div>
        <div class="small muted">立場: ${stanceOf(id)} / 傾向: ${CHAR[id].style}</div>
      </div>
    `;
  }).join("");
  box.innerHTML = `<div>${rows}</div>`;
}

function renderTop(){
  document.getElementById("placeName").textContent = LOC[S.location].name;
  document.getElementById("turn").textContent = S.turn;
  document.getElementById("alert").textContent = S.alert;
  document.getElementById("fuel").textContent = S.fuel;
  document.getElementById("objective").innerHTML = objectiveText();
  document.getElementById("situation").innerHTML = situationText();
  document.getElementById("present").innerHTML = presentText();
  document.getElementById("party").innerHTML = partyText();
  document.getElementById("inv").innerHTML = invText();
  document.getElementById("sceneImg").src = LOC[S.location].img();
  renderChars();
}

/* =========================
   Encounter & Pools
========================= */
function locationPool(loc){
  const all=Object.keys(CHAR);
  const bias={
    hq:["shigure","asashio","kasumi"],
    radio:["hatsuzuki","shigure","hibiki"],
    workshop:["takao","urakaze","hatsuzuki"],
    storage:["ikazuchi","hibiki","kasumi"],
    quarters:["kasumi","kongo","ikazuchi","urakaze"],
    mess:["kongo","urakaze","ikazuchi"],
    watch:["hatsuzuki","hibiki","shigure"],
    yard:["asashio","takao","shigure","hibiki"],
    armory:["takao","asashio","hatsuzuki"],
    dock:["asashio","kasumi","takao","hibiki"],
    bath:["kongo","ikazuchi","urakaze"],
    tunnel:["hibiki","shigure","hatsuzuki"],
    generator:["hatsuzuki","hibiki"],
    warehouse:["kasumi","takao","ikazuchi"],
  }[loc] || [];
  return [...bias, ...all, ...bias];
}

function refreshPresent(force=false){
  // 「絶対会わない」防止：基本 1人以上を確保
  const pool = locationPool(S.location);
  let count = chance(45)?2:1;
  if(force) count = Math.max(1, count);

  const pick=[];
  for(let k=0;k<40 && pick.length<count;k++){
    const id=pool[rint(pool.length)];
    if(!pick.includes(id) && !S.party.includes(id)) pick.push(id);
  }
  S.present = pick;

  // 同行者がいる場合は、出現中に表示しない（別枠）
}

function enterLocation(loc){
  S.location = loc;
  refreshPresent(true);
  sep();
  pushLog(`—— <b>${LOC[loc].name}</b> ——`);
  pushLog(`<span class="muted">${LOC[loc].situation[rint(LOC[loc].situation.length)]}</span>`);
  renderTop();
}

/* =========================
   Command -> Target UI
========================= */
const cmdGrid=document.getElementById("cmdGrid");
const modalWrap=document.getElementById("modalWrap");
const modalTitle=document.getElementById("modalTitle");
const modalHint=document.getElementById("modalHint");
const targetGrid=document.getElementById("targetGrid");
document.getElementById("modalClose").onclick=()=>closeTarget();
let pendingCmd=null;

function buildCmdButtons(){
  cmdGrid.innerHTML = CMD.map(c=>`<button data-c="${c.id}">${c.label}</button>`).join("");
  cmdGrid.querySelectorAll("button").forEach(b=>{
    b.onclick=()=>openTarget(b.dataset.c);
  });
}
buildCmdButtons();

function openTarget(cmdId){
  if(S.ended) return toast("エンド後はMENUからやり直し");
  pendingCmd = cmdId;
  const cmd = CMD.find(c=>c.id===cmdId);
  modalTitle.textContent = `対象を選択：${cmd.label}`;
  modalHint.textContent = cmd.hint;

  const targets = buildTargets(cmdId);
  targetGrid.innerHTML = targets.map(t=>{
    return `<button data-t="${t.id}">${t.label}${t.tag?`<span class="tag">${t.tag}</span>`:""}</button>`;
  }).join("");

  targetGrid.querySelectorAll("button").forEach(b=>{
    b.onclick=()=>{ runCommand(pendingCmd, b.dataset.t); };
  });

  modalWrap.classList.add("show");
}
function closeTarget(){
  modalWrap.classList.remove("show");
  pendingCmd=null;
}
document.getElementById("modalWrap").addEventListener("click",(e)=>{
  if(e.target.id==="modalWrap") closeTarget();
});

function uniqTargets(arr){
  const seen=new Set();
  return arr.filter(x=>{
    const k=x.id+"|"+x.label;
    if(seen.has(k)) return false;
    seen.add(k); return true;
  });
}

function buildTargets(cmdId){
  const L=LOC[S.location];
  const LS=S.locState[S.location];
  const t=[];

  if(cmdId==="move"){
    L.exits.forEach(e=>t.push({id:`loc:${e}`, label:`${LOC[e].name}へ`, tag:"移動"}));
    return t;
  }

  // 人物（出現中 + 同行）を分けて対象化
  if(["talk","order","apologize"].includes(cmdId)){
    if(!S.present.length && !S.party.length) return [{id:"none", label:"（誰もいない）"}];
    if(S.present.length){
      t.push({id:"sep", label:"— 出現中 —", tag:""});
      S.present.forEach(id=>t.push({id:`ch:${id}`, label:CHAR[id].name, tag:stanceOf(id)}));
    }
    if(S.party.length){
      t.push({id:"sep2", label:"— 同行 —", tag:""});
      S.party.forEach(id=>t.push({id:`ch:${id}`, label:CHAR[id].name, tag:"同行"}));
    }
    return t;
  }

  // 調べる / 触る：物 + 人物（その場にいる時だけ）
  if(["examine","touch"].includes(cmdId)){
    L.objects.forEach(o=>{
      const done = LS.examined.has(o) || LS.touched.has(o);
      t.push({id:`obj:${o}`, label:o, tag:done?"済":"場所"});
    });

    // 調査で増える「派生対象」（revealed）
    [...LS.revealed].forEach(r=>{
      if(r.startsWith("sub:")){
        const name=r.slice(4);
        t.push({id:`sub:${name}`, label:name, tag:"発見"});
      }
    });

    // その場の人物も対象に
    if(S.present.length){
      t.push({id:"sep", label:"— 艦娘 —", tag:""});
      S.present.forEach(id=>t.push({id:`ch:${id}`, label:CHAR[id].name, tag:stanceOf(id)}));
    }
    if(S.party.length){
      t.push({id:"sep2", label:"— 同行 —", tag:""});
      S.party.forEach(id=>t.push({id:`ch:${id}`, label:CHAR[id].name, tag:"同行"}));
    }
    return uniqTargets(t);
  }

  // 拾う：reveal済みの「拾える物」だけ
  if(cmdId==="pickup"){
    const items = [...LS.revealed].filter(r=>r.startsWith("item:")).map(r=>r.slice(5));
    if(!items.length) return [{id:"none", label:"（拾える物がない）"}];
    items.forEach(it=>{
      if(!S.inventory.includes(it)) t.push({id:`pick:${it}`, label:ITEMS[it]?.name ?? it, tag:"拾う"});
    });
    return t.length? t : [{id:"none", label:"（拾える物がない）"}];
  }

  // 使う：所持品 + その場の装置ショートカット
  if(cmdId==="use"){
    if(S.inventory.length){
      S.inventory.forEach(it=>t.push({id:`it:${it}`, label:ITEMS[it]?.name ?? it, tag:"所持"}));
    }
    if(S.location==="dock") t.push({id:"use:gate", label:"封鎖ゲートに使う", tag:"解除"});
    if(S.location==="dock") t.push({id:"use:ship", label:"輸送船を動かす", tag:"脱出"});
    if(S.location==="radio") t.push({id:"use:radio", label:"無線照合を進める", tag:"航路"});
    if(S.location==="workshop") t.push({id:"use:repair", label:"整備を進める", tag:"整備"});
    return t.length? t : [{id:"none", label:"（使えるものがない）"}];
  }

  if(cmdId==="hide"){
    return [
      {id:"hide:shadow", label:"物陰に隠れる", tag:"警戒↓"},
      {id:"hide:still", label:"息を殺す", tag:"疑い↓"},
    ];
  }

  if(cmdId==="run"){
    return [
      {id:"run:back", label:"引く", tag:"疑い↑"},
      {id:"run:cut", label:"迂回する", tag:"警戒↑"},
    ];
  }

  if(cmdId==="fight"){
    return [
      {id:"fight:short", label:"短い衝突", tag:"音"},
      {id:"fight:break", label:"突破", tag:"危険"},
    ];
  }

  if(cmdId==="drop"){
    if(!S.inventory.length) return [{id:"none", label:"（捨てる物がない）"}];
    return S.inventory.map(it=>({id:`drop:${it}`, label:`${ITEMS[it]?.name ?? it}を捨てる`, tag:"整理"}));
  }

  return [{id:"none", label:"（対象なし）"}];
}

/* =========================
   Core logic
========================= */
function hasItem(it){ return S.inventory.includes(it); }
function addItem(it){
  if(S.inventory.includes(it)) return;
  if(S.inventory.length >= S.invLimit){ pushLog("（所持枠がいっぱいだ）", "danger"); return; }
  S.inventory.push(it);
  pushLog(`（入手：${ITEMS[it]?.name ?? it}）`, "muted");
}
function removeItem(it){
  const i=S.inventory.indexOf(it);
  if(i>=0) S.inventory.splice(i,1);
}

function markDetected(why){
  if(!S.flags.has("detected_once")){
    S.flags.add("detected_once");
    pushLog(`空気が変わる。<span class="danger">脱走疑い</span>が立った。${why?`<span class="muted">（${why}）</span>`:""}`, "danger");
  }
}

function runCommand(cmdId, targetId){
  closeTarget();
  if(S.ended) return;

  // 見出し行のセパレータは選べない
  if(targetId==="sep" || targetId==="sep2"){ toast("対象を選んで"); return; }

  S.turn++;

  // コマンドごとのベース警戒
  const baseAlert = {
    fight:+16, touch:+5, run:+9, hide:-8, order:+2, pickup:+0, move:+2, examine:+1, talk:0, apologize:-1, use:+1, drop:0
  }[cmdId] ?? 0;
  S.alert = clamp(S.alert + baseAlert);

  if(targetId==="none"){
    pushLog("うまくいかない。", "muted");
    afterStep();
    return;
  }

  // 移動
  if(cmdId==="move" && targetId.startsWith("loc:")){
    const next=targetId.slice(4);
    pushLog(`移動… <span class="muted">${LOC[next].name}</span>`);
    // 移動で疑いが立つことがある（危険地ほど）
    const p = 6 + LOC[next].danger/2 + (S.flags.has("detected_once")?6:0);
    if(chance(p)){
      markDetected("動線を読まれた");
      S.alert = clamp(S.alert+6);
    }
    enterLocation(next);
    afterStep();
    return;
  }

  // 調べる
  if(cmdId==="examine"){
    examineEvent(targetId);
    afterStep();
    return;
  }

  // 触る
  if(cmdId==="touch"){
    touchEvent(targetId);
    afterStep();
    return;
  }

  // 拾う
  if(cmdId==="pickup" && targetId.startsWith("pick:")){
    const it=targetId.slice(5);
    pickupEvent(it);
    afterStep();
    return;
  }

  // 使う
  if(cmdId==="use"){
    useEvent(targetId);
    afterStep();
    return;
  }

  // 会話/命令/謝罪
  if(["talk","order","apologize"].includes(cmdId) && targetId.startsWith("ch:")){
    const id=targetId.slice(3);
    socialEvent(cmdId, id);
    afterStep();
    return;
  }

  // 隠れる
  if(cmdId==="hide"){
    pushLog("身を潜める。", "muted");
    S.alert = clamp(S.alert - (targetId==="hide:still"?12:8));
    // 息を殺すは「疑い」を薄める（ただし完全には消さない）
    if(targetId==="hide:still" && chance(28)){
      pushLog("気配が薄れる。視線が散った。", "ok");
      // detected_once を消さずに「捕縛イベント確率」を下げるためのフラグを立てる
      S.flags.add("cooled_once");
    }
    afterStep();
    return;
  }

  // 逃げる
  if(cmdId==="run"){
    pushLog("距離を取る。背中に視線が刺さる。", "muted");
    markDetected("逃げ腰を見せた");
    S.ale

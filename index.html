<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1,viewport-fit=cover" name="viewport"/>
<title>離島鎮守府 脱出行（基礎コード / セクション分け版）</title>
<style>
  :root{
    --bg:#0e0f12; --panel:#171a20; --panel2:#12141a; --line:#2a2f3a;
    --txt:#e9edf4; --muted:#a9b2c3; --accent:#69c0ff; --danger:#ff6b6b; --ok:#7CFF7C;
    --btn:#232836; --btn2:#2b3142; --r:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  header{padding:10px 12px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,var(--panel),var(--panel2))}
  header .title{font-weight:900;font-size:16px}
  header .sub{color:var(--muted);font-size:12px;margin-top:2px}
  main{padding:12px;display:flex;flex-direction:column;gap:10px;min-height:calc(100vh - 56px)}
  .row{display:flex;gap:10px;align-items:stretch}
  .col{flex:1;display:flex;flex-direction:column;gap:10px;min-width:0}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--r);overflow:hidden}
  .card .hd{padding:10px 10px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center;justify-content:space-between}
  .card .hd .h{font-weight:900}
  .card .bd{padding:10px}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);color:var(--muted);font-size:12px}
  .pill b{color:var(--txt)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  button{
    width:100%;border:1px solid rgba(255,255,255,.10);background:var(--btn);color:var(--txt);
    padding:10px 8px;border-radius:12px;font-weight:800;letter-spacing:.02em;
    transition:.08s transform,.08s background;
  }
  button:active{transform:scale(.99);background:var(--btn2)}
  button[disabled]{opacity:.35}
  .log{height:44vh;overflow:auto;line-height:1.65}
  .log .sep{margin:10px 0;border-top:1px dashed rgba(255,255,255,.15)}
  .muted{color:var(--muted)}
  .danger{color:var(--danger)}
  .ok{color:var(--ok)}
  .small{font-size:12px}
  .right{margin-left:auto}
  .tag{display:inline-block;font-size:11px;color:var(--muted);border:1px solid rgba(255,255,255,.12);padding:2px 6px;border-radius:999px;margin-left:6px}
  .hr{height:1px;background:var(--line);margin:10px 0}
  .sceneImg{height:150px;border-radius:14px;border:1px solid rgba(255,255,255,.10);overflow:hidden;background:#0b0c10}
  .sceneImg img{width:100%;height:100%;object-fit:cover;display:block;opacity:.95}

  /* --- Media / Portrait UI --- */
  .portraitRow{display:flex;gap:10px;align-items:stretch;margin-top:10px}
  .portraitBox{width:120px;min-width:120px;height:140px;border-radius:14px;border:1px solid rgba(255,255,255,.10);overflow:hidden;background:#0b0c10;display:flex;align-items:center;justify-content:center}
  .portraitBox img{width:100%;height:100%;object-fit:cover;display:block}
  .portraitInfo{flex:1;min-width:0;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);padding:10px;display:flex;flex-direction:column;gap:6px}
  .portraitInfo .nm{font-weight:950}
  .portraitInfo .tx{color:var(--muted);font-size:12px;line-height:1.55}
  input[type="range"]{width:100%}


  .modalWrap{position:fixed;inset:0;background:rgba(0,0,0,.62);display:none;align-items:flex-end;justify-content:center;padding:12px}
  .modalWrap.show{display:flex}
  .modal{
    width:min(780px,100%);max-height:84vh;overflow:auto;
    background:var(--panel);border:1px solid var(--line);border-radius:18px;
    box-shadow:0 14px 50px rgba(0,0,0,.45);
  }
  .modal .top{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
  .modal .top .t{font-weight:950}
  .modal .top .x{margin-left:auto;width:auto;padding:8px 10px;border-radius:12px}
  .modal .body{padding:12px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:rgba(20,22,28,.95);border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:14px;display:none}
  .toast.show{display:block}

  /* ===== UI LAYOUT v3: Sidebar HUD + Center Stage ===== */
  .uiRow{display:flex;gap:10px;align-items:stretch}
  .leftCol{max-width:320px}
  .stageCard .bd{padding:10px}
  
  .midHud{margin-top:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(0,0,0,.22);padding:10px 12px;display:flex;flex-direction:column;gap:8px}
  .midLine{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
  .midLabel{font-size:12px;color:rgba(255,255,255,.70)}
  .midText{font-size:14px}
  .midChips{display:flex;gap:8px;flex-wrap:wrap}
  .smallTag{font-size:12px;padding:2px 8px}
.timeBanner{height:92px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:linear-gradient(180deg,#0b1224,#0b0c10);position:relative}
  .timeBanner img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:.95}
  .stageInfo{margin-top:10px;padding:10px 12px;border-radius:14px;background:rgba(12,14,20,.55);border:1px solid rgba(255,255,255,.10)}
  .locStage{margin-top:10px;position:relative;border:1px solid rgba(255,255,255,.10);border-radius:18px;overflow:hidden;background:#0b0c10;height:56vh;min-height:440px;max-height:820px}
  .locStage img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:.95}
  .sceneShade{position:absolute;inset:0;background:linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.55))}
  .hudChips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(18,22,30,.62);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(6px);font-size:12px;color:rgba(255,255,255,.9)}
  .chip b{font-weight:800;color:#fff}
  .log{height:52vh;max-height:none}

  /* Portrait overlay (kept) */
  .scenePortrait{position:absolute;inset:0;pointer-events:none}
  .scenePortrait .portraitBox{width:160px;height:200px;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.35);flex:0 0 auto}
  .scenePortrait .bubble{flex:1;min-height:86px;max-height:180px;overflow:auto;padding:10px 12px;border-radius:18px;background:rgba(12,14,20,.70);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(6px)}
  .scenePortrait .nm{font-weight:900;margin-bottom:4px}
  .scenePortrait .tx{color:rgba(255,255,255,.84);line-height:1.45}

  /* Multi-portrait lane */
  .scenePortrait{position:absolute;inset:0;pointer-events:none}
  .scenePortrait .portraitsLane{position:absolute;inset:0;pointer-events:auto}
  .scenePortrait .pCard{
    width:120px;height:170px;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.14);
    background:rgba(0,0,0,.35);position:relative;cursor:pointer;pointer-events:auto;
    transform-origin:bottom left;
  }
  .scenePortrait .pCard img{width:100%;height:100%;object-fit:cover;display:block}
  .scenePortrait .pCard .lbl{
    position:absolute;left:8px;right:8px;bottom:8px;
    display:flex;gap:6px;align-items:center;justify-content:space-between;
    font-size:12px;font-weight:900;text-shadow:0 2px 10px rgba(0,0,0,.65);
  }
  .scenePortrait .pCard .dist{
    font-size:11px;font-weight:800;padding:2px 8px;border-radius:999px;
    background:rgba(12,14,20,.70);border:1px solid rgba(255,255,255,.14);
    color:rgba(255,255,255,.85)
  }
  .scenePortrait .pCard.near{transform:scale(1.10)}
  .scenePortrait .pCard.mid{transform:scale(0.95);opacity:.92}
  .scenePortrait .pCard.far{transform:scale(0.82);opacity:.82}
  .scenePortrait .pCard.focus{outline:2px solid rgba(105,192,255,.70)}
  .scenePortrait .bubble{pointer-events:auto}


  @media (max-width: 980px){
    .uiRow{flex-direction:column}
    .leftCol{max-width:none}
    .locStage{height:34vh}
    .log{height:34vh}
  }


  /* ===== v4 tweaks per HUD/layout request ===== */
  .placeBlock{display:none}
  .placeStatus{font-size:12px;opacity:.85;line-height:1.2}
  .card .hd{align-items:flex-start}
  /* remove old portrait card feel; make stage sprites big */
  .scenePortrait{position:absolute;inset:0;pointer-events:none}
  .portraitsLane{position:absolute;inset:0;pointer-events:auto}
  .portraitsLane .sprite{
    position:absolute;
    top:0;
    height:108%;
    width:auto;
    object-fit:cover;
    object-position: top center;
    pointer-events:auto;
    filter: drop-shadow(0 10px 18px rgba(0,0,0,.55));
    opacity:.98;
  }
  .portraitsLane .sprite.mid{height:96%;opacity:.95}
  .portraitsLane .sprite.far{height:78%;opacity:.85}
  .portraitsLane .sprite.unaware{opacity:.82}
  .portraitsLane .sprite.focus{filter: drop-shadow(0 12px 22px rgba(0,0,0,.70));opacity:1}



/* --- Layout lock: keep right column on the right (no wrap) --- */
.uiRow{flex-wrap:nowrap;align-items:stretch}
.uiRow>.col{min-width:0}
.uiRow>.leftCol{flex:0 0 320px}
.uiRow>.rightCol{flex:0 0 440px}
.uiRow>.centerCol{flex:1 1 auto}

/* --- Mid HUD: location name lives here --- */
.midLine{display:flex;gap:10px;align-items:center}
.midPlace{flex:0 0 auto;min-width:72px;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);font-weight:700}
.midText{flex:1 1 auto}
#placeName{opacity:.25;font-weight:600}

/* --- Portraits: anchor to bottom; keep feet at the floor --- */
.locStage{position:relative}
.scenePortrait{position:absolute;inset:0;display:flex;align-items:flex-end;justify-content:center;pointer-events:none}
.portraitsLane{width:100%;height:100%;display:flex;gap:18px;align-items:flex-end;justify-content:center;padding:0 18px 0 18px}
.portraitsLane img{max-height:100%;height:100%;width:auto;object-fit:contain;object-position:center bottom;display:block}
</style>
</head>
<body>
<header>
<div class="title">離島鎮守府 脱出行（基礎コード / セクション分け版）</div>
<div class="sub">修正しやすいように「定数→状態→UI→遭遇→各コマンド→会話データ」の順に整理</div>
</header>
<main>
  <div class="card">
    <div class="hd"><div class="pill"><span>ターン</span> <b id="turn">0</b></div>
      <div class="pill"><span>警戒</span> <b id="alert">10</b></div>
      <div class="pill"><span>燃料</span> <b id="fuel">25</b></div>
      <div class="pill"><span>脱走疑い</span> <b id="suspect">なし</b></div>
      <button class="right" id="btnMenu" style="width:auto">MENU</button>
    </div>
  </div>

  <div class="row uiRow">
    <div class="col leftCol" style="max-width:320px">
      <div class="card">
        <div class="hd"><div class="h">目的</div></div>
        <div class="bd">
          <div class="objectiveLine">航路・鍵・整備・封鎖解除などを進める。</div><div class="hr"></div><div class="chip">目的 <b id="objective">—</b></div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><div class="h">ログ</div><div class="small muted">（新しいほど下）</div></div>
        <div class="bd log" id="log"></div>
      </div>
    </div>

    <div class="col centerCol">
      <div class="card stageCard">
        <div class="hd">
          <div class="h" id="placeName">—</div>
          <div class="small muted" id="timeLabel">—</div>
        </div>
        <div class="bd">
          <div class="timeBanner" id="timeBanner"><img alt="time" id="timeImg"/></div>

          <div class="midHud">
            <div class="midLine">
              <div class="midPlace" id="placeInline">—</div>
              <div class="midText" id="situationText">—</div>
              <div class="chip smallTag" id="suspectTagInline" style="display:none"></div>
            </div>
            <div class="midChips">
              <div class="chip">出現 <b id="present">—</b></div>
              <div class="chip">同行 <b id="party">—</b></div>
              <div class="chip">所持 <b id="inv">—</b></div>
            </div>
          </div>
<div class="locStage" id="scenePane">
            <img alt="scene" id="sceneImg"/>
            <div class="sceneShade"></div>

            <div class="scenePortrait" id="portraitRow" style="display:none">
              <div class="portraitsLane" id="stagePortraits"></div>
<div class="tx" id="charPortraitFlavor">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col rightCol" style="max-width:440px">
      <div class="card">
        <div class="hd"><div class="h">コマンド</div><div class="small muted">押す→対象選択</div></div>
        <div class="bd"><div class="grid3" id="cmdGrid"></div></div>
      </div>
      <div class="card">
        <div class="hd"><div class="h">艦娘</div><div class="small muted">信頼/親密</div></div>
        <div class="bd" id="chars"></div>
      </div>
    </div>
  </div>
</main>
<!-- 対象選択モーダル -->
<div class="modalWrap" id="targetWrap">
<div class="modal">
<div class="top">
<div class="t" id="targetTitle">—</div>
<button class="x" id="targetClose">閉じる</button>
</div>
<div class="body">
<div class="small muted" id="targetHint">—</div>
<div class="hr"></div>
<div class="grid2" id="targetGrid"></div>
</div>
</div>
</div>
<!-- 返答選択モーダル（NPC台詞はログに確定／返答だけ選ぶ） -->
<div class="modalWrap" id="dlgWrap">
<div class="modal">
<div class="top">
<div class="t" id="dlgTitle">返答</div>
<button class="x" id="dlgClose">閉じる</button>
</div>
<div class="body">
<div class="small muted" id="dlgHint"></div>
<div class="hr"></div>
<div class="grid2" id="dlgChoices"></div>
</div>
</div>
</div>
<!-- メニュー -->
<div class="modalWrap" id="menuWrap">
<div class="modal">
<div class="top">
<div class="t">MENU</div>
<button class="x" id="menuClose">閉じる</button>
</div>
<div class="body">
<div class="grid2">
<button id="btnSave">セーブ（端末）</button>
<button id="btnLoad">ロード（端末）</button>
<button id="btnRestart">最初から</button>
<button id="btnReplay">同条件で最初から（seed維持）</button>
</div>
<div class="hr"></div>
<div class="small muted">音量・BGM</div>
<div class="grid2" style="margin-top:8px">
  <button id="btnBgmToggle">BGM：OFF</button>
  <button id="btnSfxToggle">SE：ON</button>
</div>
<div style="margin-top:8px">
  <div class="small muted">BGM音量</div>
  <input id="bgmVol" type="range" min="0" max="100" value="35"/>
</div>
<div style="margin-top:8px">
  <div class="small muted">SE音量</div>
  <input id="sfxVol" type="range" min="0" max="100" value="60"/>
</div>
<div class="hr"></div>
<div class="small muted">
        ・端末セーブは localStorage 使用。<br/>
        ・同条件リプレイは調整に便利。<br/>
</div>
</div>
</div>
</div>
<audio id="bgm" loop preload="none"></audio>
<audio id="sfx" preload="none"></audio>
<div class="toast" id="toast"></div>
<script>
/* =========================================================
   00) ここが「入口」：全部を一つの App にまとめる
========================================================= */
const App = (() => {

/* =========================================================
   00.5) メディア（BGM/SE）
   - 音源は任意：存在しなければ無音で動作
   - 端末制約で「最初の操作後」に再生が解禁される
========================================================= */
const Media = (() => {
  const elBgm = document.getElementById("bgm");
  const elSfx = document.getElementById("sfx");

  const state = {
    bgmOn:false,
    sfxOn:true,
    bgmVol:0.35,
    sfxVol:0.60,
    unlocked:false,
    currentKey:"",
  };

  const BGM_MAP = {
    early:   "./music/early.mp3",
    morning: "./music/morning.mp3",
    noon:    "./music/noon.mp3",
    evening: "./music/evening.mp3",
    night:   "./music/night.mp3",
  };

  function setVol(){
    try{ elBgm.volume = state.bgmVol; }catch(_){}
    try{ elSfx.volume = state.sfxVol; }catch(_){}
  }

  function unlock(){
    if(state.unlocked) return;
    state.unlocked = true;
    // iOS/Chrome対策：無音でも一度 play() を試す
    if(state.bgmOn) playBgmForPhase(phaseOfHour(clockHour()));
  }

  function playBgmForPhase(ph){
    const key = ph || "night";
    if(state.currentKey === key) return;
    state.currentKey = key;

    const src = BGM_MAP[key] || BGM_MAP.night;
    if(!state.bgmOn) return;

    try{
      if(elBgm.src !== src) elBgm.src = src;
      elBgm.volume = 0.0001; // フェードイン前
      const p = elBgm.play();
      if(p && p.catch) p.catch(()=>{});
      // フェードイン（軽く）
      const target = state.bgmVol;
      const steps = 12;
      let i=0;
      const tick = ()=> {
        i++;
        const v = Math.min(target, (target/steps)*i);
        elBgm.volume = v;
        if(i<steps) setTimeout(tick, 70);
      };
      tick();
    }catch(_){}
  }

  function stopBgm(){
    try{
      const steps = 10;
      let i=steps;
      const start = elBgm.volume || 0;
      const tick = ()=> {
        i--;
        const v = (start/steps)*Math.max(i,0);
        elBgm.volume = v;
        if(i>0) setTimeout(tick, 50);
        else { try{ elBgm.pause(); }catch(_){} }
      };
      tick();
    }catch(_){}
  }

  function updateBgm(){
    if(!state.bgmOn) return;
    playBgmForPhase(phaseOfHour(clockHour()));
  }

  function toggleBgm(){
    state.bgmOn = !state.bgmOn;
    if(state.bgmOn){
      if(state.unlocked) playBgmForPhase(phaseOfHour(clockHour()));
    }else{
      stopBgm();
    }
    return state.bgmOn;
  }

  function toggleSfx(){
    state.sfxOn = !state.sfxOn;
    return state.sfxOn;
  }

  function sfx(name){
    if(!state.sfxOn) return;
    const map = {
      enter:"./sfx/enter.mp3",
      talk:"./sfx/talk.mp3",
      item:"./sfx/item.mp3",
      click:"./sfx/click.mp3",
    };
    const src = map[name];
    if(!src) return;
    try{
      elSfx.pause();
      elSfx.currentTime = 0;
      elSfx.src = src;
      elSfx.volume = state.sfxVol;
      const p = elSfx.play();
      if(p && p.catch) p.catch(()=>{});
    }catch(_){}
  }

  function setBgmVol(v){ state.bgmVol = Math.max(0, Math.min(1, v)); setVol(); }
  function setSfxVol(v){ state.sfxVol = Math.max(0, Math.min(1, v)); setVol(); }

  return {state, unlock, updateBgm, toggleBgm, toggleSfx, sfx, setBgmVol, setSfxVol};
})();


/* =========================================================
   01) 定数（世界データ）
   - ここを増やす：場所 / 艦娘 / アイテム / コマンド
========================================================= */
const CMD = [
  {id:"move", label:"移動", tag:"静か", hint:"移動先を選ぶ"},
  {id:"examine", label:"調べる", tag:"静か", hint:"場所/物/人物を調べる（調べるほど対象が増える）"},
  {id:"touch", label:"触る", tag:"目立つ", hint:"装置/扉/人物に触れる"},
  {id:"hide", label:"隠れる", tag:"静か", hint:"回避（見られてる時は怪しまれることも）"},
  {id:"pickup", label:"拾う", tag:"目立つ", hint:"発見済みの物だけ拾える（有限）"},
  {id:"drop", label:"捨てる", tag:"静か", hint:"所持枠整理"},
  {id:"talk", label:"話す", tag:"目立つ", hint:"対象選択→NPC台詞はログ確定→返答だけ選ぶ"},
  {id:"use", label:"使う", tag:"目立つ", hint:"アイテム/装置に使う"},
  {id:"order", label:"命令", tag:"目立つ", hint:"同行/指示。信頼が低いと反発"},
  {id:"run", label:"逃げる", tag:"危険", hint:"露骨な離脱行動（疑いが濃くなる）"},
  {id:"apologize", label:"謝る", tag:"静か", hint:"空気を戻す（場面によって有効/無効）"},
  {id:"fight", label:"闘う", tag:"危険", hint:"交戦。疑いは確定する"},
];

const CHAR = {
  shigure:{name:"時雨"},
  asashio:{name:"朝潮"},
  kasumi:{name:"霞"},
  takao:{name:"高雄"},
  kongo:{name:"金剛"},
  hatsuzuki:{name:"初月"},
  urakaze:{name:"浦風"},
  ikazuchi:{name:"雷"},
  hibiki:{name:"響"},
};

// 内蔵の簡易背景（あとで画像に差し替え可）
function phaseOfHour(h){
  // h: 0..24
  if(h>=5 && h<8) return "early";      // 早朝
  if(h>=8 && h<11) return "morning";   // 朝
  if(h>=11 && h<16) return "noon";     // 昼
  if(h>=16 && h<19) return "evening";  // 夕
  if(h>=19 || h<0) return "night";
  return "night";
}
function paletteForHour(h){
  // 空の色（上→下）
  const p = phaseOfHour(h);
  if(p==="early")   return {skyA:"#13224a", skyB:"#ffb37a", haze:"#ffd7b0", star:0.20, sun:0.35, moon:0.70};
  if(p==="morning") return {skyA:"#4b8bd6", skyB:"#bfe6ff", haze:"#ffffff", star:0.06, sun:0.90, moon:0.15};
  if(p==="noon")    return {skyA:"#2b79e6", skyB:"#b8e5ff", haze:"#ffffff", star:0.00, sun:1.00, moon:0.00};
  if(p==="evening") return {skyA:"#2a2d6e", skyB:"#ff7b61", haze:"#ffd0c2", star:0.10, sun:0.55, moon:0.35};
  // night
  return {skyA:"#060a16", skyB:"#111a2f", haze:"#8fb6ff", star:0.55, sun:0.00, moon:1.00};
}
function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function lerp(a,b,t){ return a + (b-a)*t; }

function sunMoonF
